{{- if .Values.app.isAccessible }}
{{- if .Values.app.ingress.http }}
{{- range $i, $deployment := .Values.app.deployments }}
{{- if gt $deployment.routingSettings.weight 0.0}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ empty $.Values.app.id | ternary $.Values.app.name (printf "%s-%s" $.Values.app.name $.Values.app.id) }}-{{ $i }}-http-ingress
  annotations:
    {{- if gt $i 0 }}
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "{{ $deployment.routingSettings.weight }}"
    {{- end }}
    {{- $data := dict "kind" "Ingress" "apiVersion" "networking.k8s.io/v1" "metadataItems" $.Values.app.metadataAnnotations }}
    {{- include "ketch.renderMetadata" $data | nindent 4 }}
  labels:
    {{- if $.Values.app.id }}
    {{ $.Values.app.group }}/app-id: {{ $.Values.app.id | quote }}
    {{- end }}
    {{ $.Values.app.group }}/app-name: {{ $.Values.app.name | quote }}
    {{ $.Values.app.group }}/app-deployment-version: {{ $deployment.version | quote }}
spec:
  {{- if $.Values.ingressController.className }}
  ingressClassName: {{ $.Values.ingressController.className | quote }}
  {{- end }}
  rules:
  {{- range $_, $cname := $.Values.app.ingress.http }}
  - host: {{ $cname }}
    http:
      paths:
      {{- range $_, $process := $deployment.processes }}
        {{- if $process.routable }}
      - backend:
          service:
            name: {{ empty $.Values.app.id | ternary $.Values.app.name (printf "%s-%s" $.Values.app.name $.Values.app.id) }}-{{ $process.name }}-{{ $deployment.version }}
            port:
              number: {{ $process.publicServicePort }}
        pathType: ImplementationSpecific
        {{- end }}
      {{- end }}
  {{- end }}
{{- end }}
---
{{- end }}
{{- end }}
{{- end }}

{{- if .Values.app.isAccessible }}
{{- if .Values.app.ingress.https }}
{{- range $i, $deployment := .Values.app.deployments }}
{{- if gt $deployment.routingSettings.weight 0.0}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ empty $.Values.app.id | ternary $.Values.app.name (printf "%s-%s" $.Values.app.name $.Values.app.id) }}-{{ $i }}-https-ingress
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    {{- if gt $i 0 }}
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "{{ $deployment.routingSettings.weight }}"
    {{- end }}
  labels:
    {{- if $.Values.app.id }}
    {{ $.Values.app.group }}/app-id: {{ $.Values.app.id | quote }}
    {{- end }}
    {{ $.Values.app.group }}/app-name: {{ $.Values.app.name | quote }}
spec:
  {{- if $.Values.ingressController.className }}
  ingressClassName: {{ $.Values.ingressController.className | quote }}
  {{- end }}
  tls:
    {{- range $_, $https := $.Values.app.ingress.https }}
    - hosts:
        - {{ $https.cname }}
      secretName: {{ $https.secretName }}
    {{- end }}
  rules:
  {{- range $_, $https := $.Values.app.ingress.https }}
  - host: {{ $https.cname }}
    http:
      paths:
      {{- range $_, $process := $deployment.processes }}
      {{- if $process.routable }}
        - path: /
          pathType: Prefix
          backend:
            service:
              name: {{ empty $.Values.app.id | ternary $.Values.app.name (printf "%s-%s" $.Values.app.name $.Values.app.id) }}-{{ $process.name }}-{{ $deployment.version }}
              port:
                number: {{ $process.publicServicePort }}
        {{- end }}
      {{- end }}
  {{- end }}
  {{- end }}
---
{{- end }}
{{- end }}
{{- end }}
